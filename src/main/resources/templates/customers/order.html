<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Books Store Application</title>
    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"> 
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
<!--/* Header fragment */-->
<nav class="navbar navbar-inverse navbar-fixed-top" th:replace="fragments/header :: header">
       
</nav>

<div class="books-content" style="font-size: 1.1em;">
    <div th:insert="fragments/breadcrumb :: breadcrumb('Place Order')"></div>
</div>


<div class="actions" style="gap: 20px;">
    <form th:action="@{/v1/web/home}" method="get" style="margin-left: 5px;">
        <button type="submit">Browse Books</button>
    </form>
    <form th:action="@{/v1/web/customers/checkout}" method="get" >
        <button type="submit">Back to Cart</button>
    </form>
</div>

<div class="edit-form-header center" >
    <form th:action="@{/v1/web/customers/order}" method="post" class="edit-form-header form" style="min-width:300px;">
        <!-- CSRF -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!-- Messages -->
        <div th:if="${errorMessage}" class="error-message" style="color:red; margin-bottom:15px; padding:10px; border:1px solid red; background-color:#ffe6e6; border-radius:4px;">
            <span th:text="${errorMessage}"></span>
        </div>
        <div th:if="${successMessage}" class="success-message" style="color:green; margin-bottom:15px; padding:10px; border:1px solid green; background-color:#e6ffe6; border-radius:4px;">
            <span th:text="${successMessage}"></span>
        </div>

        <div th:if="${successMessage == null or #strings.isEmpty(successMessage)}" style="flex-direction:column">
            <!-- Display-only total (do NOT submit this to the server) -->
            <div class="form-group">
                <label>Order Total:</label>
                <div id="orderTotal" th:text="${orderTotal}" style="width:100%; background-color:#f0f0f0; padding:.5rem;"></div>
                <!-- if you insist on an input, make it disabled so it won't submit -->
                <!-- <input type="text" th:value="${orderTotal}" disabled style="width:100%; background:#f0f0f0;" /> -->
            </div>

            <!-- Temporary card field (replace with hosted fields ASAP) -->
            <div class="form-group">
                <label for="creditCardNumber">Credit Card Number:</label>
                <input
                        type="text"
                        id="creditCardNumber"
                        name="creditCardNumber"
                        placeholder="1234 5678 9012 3456"
                        required
                        autocomplete="cc-number"
                        inputmode="numeric"
                        maxlength="23"
                        pattern="^[0-9][0-9\s-]{11,22}$"
                        aria-describedby="ccHelp"
                </input>
                <small id="ccHelp">We donâ€™t store card numbers. Use digits only; spaces are ok.</small>
            </div>

            <div class="form-actions" th:if="${errorMessage == null or #strings.isEmpty(errorMessage)}">
                <button type="submit" id="payBtn">Make Payment</button>
            </div>
        </div>
    </form>
</div>

<script>
    // Basic Luhn check + normalization (client-side convenience; server must also validate)
    function luhnOk(num) {
        let s = 0, alt = false;
        for (let i = num.length - 1; i >= 0; i--) {
            let n = parseInt(num.charAt(i), 10);
            if (alt) { n *= 2; if (n > 9) n -= 9; }
            s += n; alt = !alt;
        }
        return s % 10 === 0;
    }

    const input = document.getElementById('creditCardNumber');
    const btn = document.getElementById('payBtn');

    // format as 4-4-4-4 groups (non-destructive)
    input.addEventListener('input', () => {
        const digits = input.value.replace(/[^\d]/g, '').slice(0, 19);
        const groups = digits.match(/.{1,4}/g);
        input.value = groups ? groups.join(' ') : '';
    });

    // prevent submit if Luhn fails
    btn?.addEventListener('click', (e) => {
        const digits = input.value.replace(/[^\d]/g, '');
        if (digits.length < 12 || !luhnOk(digits)) {
            e.preventDefault();
            alert('Please enter a valid card number.');
            input.focus();
        }
    });
</script>

</body>
</html>