<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Books Store Application</title>
    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Stripe.js (ok in head). Do NOT initialize here. -->
    <script src="https://js.stripe.com/v3/"></script>

    <style>
        #payment-element { margin-top: 12px; }
        #payment-message { display:none; margin-top: 12px; }
        .is-loading { opacity: 0.7; pointer-events: none; }
    </style>
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top" th:replace="fragments/header :: header"></nav>

<div class="books-content" style="font-size: 1.1em;">
    <div th:insert="fragments/breadcrumb :: breadcrumb('Place Order')"></div>
</div>

<div class="actions" style="gap: 20px;">
    <form th:action="@{/v1/web/home}" method="get" style="margin-left: 5px;">
        <button type="submit">Browse Books</button>
    </form>
    <form th:action="@{/v1/web/customers/checkout}" method="get">
        <button type="submit">Back to Cart</button>
    </form>
</div>

<div class="edit-form-header center">
    <!-- We keep a form for layout only; no card data is posted to your server -->
    <form id="payment-form" class="edit-form-header form" style="min-width:300px;">
        <!-- CSRF harmless to keep, but unused here -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!-- Messages -->
        <div th:if="${errorMessage}" class="error-message" style="color:red; margin-bottom:15px; padding:10px; border:1px solid red; background-color:#ffe6e6; border-radius:4px;">
            <span th:text="${errorMessage}"></span>
        </div>
        <div th:if="${successMessage}" class="success-message" style="color:green; margin-bottom:15px; padding:10px; border:1px solid green; background-color:#e6ffe6; border-radius:4px;">
            <span th:text="${successMessage}"></span>
        </div>

        <div th:if="${successMessage == null or #strings.isEmpty(successMessage)}" style="flex-direction:column">
            <!-- Display-only total -->
            <div class="form-group">
                <label>Order Total:</label>
                <div id="orderTotal" th:text="${orderTotal}" style="width:100%; background-color:#f0f0f0; padding:.5rem;"></div>
            </div>

            <!-- Stripe Payment Element -->
            <div class="form-group">
                <label>Payment details:</label>
                <div id="payment-element"></div>
                <div id="payment-message" role="alert"></div>
            </div>

            <div class="form-actions" th:if="${errorMessage == null or #strings.isEmpty(errorMessage)}" style="display:flex; gap:8px;">
                <!-- Important: type=button so the form doesn't submit -->
                <button type="button" id="payButton">Make Payment - Stripe</button>
                <a th:href="@{/v1/web/customers/order/cancel}" class="button" style="padding:.5rem .75rem; border:1px solid #ccc; text-decoration:none;">Cancel</a>
            </div>
        </div>
    </form>
</div>

<!-- Inject server values and initialize Stripe AFTER the DOM exists -->
<script th:inline="javascript">
    const STRIPE_PK     = /*[[${stripePublishableKey}]]*/ "";
    const CLIENT_SECRET = /*[[${stripeClientSecret}]]*/ "";
    const RETURN_URL    = /*[[@{/v1/web/customers/order/success}]]*/ "";
</script>

<script>
    // Guard against missing config
    if (!STRIPE_PK || !CLIENT_SECRET) {
        console.error("Stripe keys missing: check controller sets stripePublishableKey & stripeClientSecret.");
    }

    const stripe   = Stripe(STRIPE_PK);
    const elements = stripe.elements({ clientSecret: CLIENT_SECRET, appearance: { theme: 'stripe' } });
    const paymentElement = elements.create('payment');
    paymentElement.mount('#payment-element');

    const payBtn = document.getElementById('payButton');
    const msgEl  = document.getElementById('payment-message');

    function setLoading(v) {
        if (!payBtn) return;
        payBtn.disabled = v;
        payBtn.classList.toggle('is-loading', v);
        payBtn.textContent = v ? 'Processingâ€¦' : 'Make Payment - Stripe';
    }
    function showMessage(text) {
        if (!msgEl) return;
        msgEl.textContent = text || '';
        msgEl.style.display = text ? 'block' : 'none';
    }

    payBtn?.addEventListener('click', async () => {
        setLoading(true);
        showMessage('');

        const { error } = await stripe.confirmPayment({
            elements,
            confirmParams: { return_url: RETURN_URL }  // Stripe handles 3DS & redirects back
            // You can add receipt_email or shipping here if needed
        });

        if (error) {
            showMessage(error.message || 'Payment failed. Please check your details.');
            setLoading(false);
        }
        // On success, Stripe redirects to RETURN_URL; no code here runs.
    });
</script>
</body>
</html>
